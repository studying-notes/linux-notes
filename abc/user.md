# 用户与权限

- [用户与权限](#用户与权限)
  - [用户身份与能力](#用户身份与能力)
  - [文件权限与归属](#文件权限与归属)
  - [文件的特殊权限](#文件的特殊权限)
    - [SUID](#suid)
    - [SGID](#sgid)
    - [SBIT](#sbit)
  - [文件的隐藏权限](#文件的隐藏权限)
    - [chattr 命令](#chattr-命令)
    - [lsattr 命令](#lsattr-命令)
  - [文件访问控制列表](#文件访问控制列表)
    - [setfacl 命令](#setfacl-命令)
    - [getfacl 命令](#getfacl-命令)
  - [su 命令与 sudo 服务](#su-命令与-sudo-服务)

## 用户身份与能力

在 Linux 系统中，UID 就相当于我们的身份证号码一样具有唯一性，因此可通过用户的 UID 值来判断用户身份。

- 管理员 UID 为 0：系统的管理员用户。
- 系统用户 UID 为 1～999： Linux 系统为了避免因某个服务程序出现漏洞而被黑客提权至整台服务器，默认服务程序会有独立的系统用户负责运行，进而有效控制被破坏范围。
- 普通用户 UID 从 1000 开始：是由管理员创建的用于日常工作的用户。
- UID 是不能冲突的，而且管理员创建的普通用户的 UID 默认是从 1000
开始的（即使前面有闲置的号码）。

为了方便管理属于同一组的用户，Linux 系统中还引入了用户组的概念。通过使用用户组号码（GID，Group IDentification），我们可以把多个用户加入到同一个组中，从而方便为组中的用户统一规划权限或指定任务。

在 Linux 系统中创建每个用户时，将自动创建一个与其同名的基本用户组，而且这个基本用户组只有该用户一个人。如果该用户以后被归纳入其他用户组，则这个其他用户组称之为扩展用户组。一个用户只有一个基本用户组，但是可以有多个扩展用户组，从而满足日常的工作需要。


## 文件权限与归属

尽管在 Linux 系统中一切都是文件，但是每个文件的类型不尽相同，因此 Linux 系统使用了不同的字符来加以区分，常见的字符如下所示：

- -：普通文件。
- d：目录文件。
- l：链接文件。
- b：块设备文件。
- c：字符设备文件。
- p：管道文件。

在 Linux 系统中，每个文件都有所属的所有者和所有组，并且规定了文件的所有者、所有组以及其他人对文件所拥有的可读（r）、可写（w）、可执行（x）等权限。

对于一般文件来说，权限比较容易理解：“可读”表示能够读取文件的实际内容；“可写”表示能够编辑、新增、修改、删除文件的实际内容；“可执行”则表示能够运行一个脚本程序。

对于目录文件来说，“可读”表示能够读取目录内的文件列表；“可写”表示能够在目录内新增、删除、重命名文件；而“可执行”则表示能够进入该目录。

文件的读、写、执行权限可以简写为 `rwx`，亦可分别用数字 4、2、1 来表示，**文件所有者**，**所属组**及**其他用户**权限之间无关联，文件权限的字符与数字表示如下所示：

| 权限项 | 读 | 写 | 执行 |
| --- | --- | --- | --- |
| 字符表示 | r | w | x |
| 数字表示 | 4 | 2 | 1 |

文件权限的数字法表示基于字符表示（`rwx`）的权限计算而来，其目的是简化权限的表示。例如，若某个文件的权限为 7 则代表可读、可写、可执行（4+2+1）；若权限为 6 则代表可读、可写（4+2）。

现在有这样一个文件，其所有者拥有可读、可写、可执行的权限，其文件所属组拥有可读、可写的权限；而且其他人只有可读的权限。那么，这个文件的权限就是 `rwxrw-r--`，数字法表示即为 764。

```bash
$ ls -dl workdir
drwxr-xr-x 2 root root 4096 Jan 11 19:55 workdir
```

## 文件的特殊权限

SUID、SGID 与 SBIT 是一种对文件权限进行设置的特殊功能，可以与一般权限同时使用，以弥补一般权限不能实现的功能。

### SUID

SUID 是一种对**二进制程序**进行设置的特殊权限，可以让二进制程序的执行者临时拥有属主的权限（仅对拥有执行权限的二进制程序有效）。例如，所有用户都可以执行 `passwd` 命令来修改自己的用户密码，而用户密码保存在 `/etc/shadow` 文件中。仔细查看这个文件就会发现它的默认权限是 000，也就是说除了 root 管理员以外，所有用户都没有查看或编辑该文件的权限。但是，在使用 `passwd` 命令时如果加上 SUID 特殊权限位，就可让普通用户临时获得程序所有者的身份，把变更的密码信息写入到 `shadow` 文件中。

查看 `passwd` 命令属性时发现所有者的权限由 rwx 变成了 rws，其中 x 改变成 s 就意味着该文件被赋予了 SUID 权限。如果原先权限位上没有 x 执行权限，那么被赋予特殊权限后将变成大写的 S。

```bash
$ ls -l /etc/shadow
-rw-r----- 1 root shadow 867 Jan 15 10:32 /etc/shadow
```

```bash
$ ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 59640 Mar 23  2019 /usr/bin/passwd
```

### SGID

SGID 实现了如下两种功能：

- 让执行者临时拥有属组的权限（对拥有执行权限的二进制程序进行设置）；

- 在某个目录中创建的文件自动继承该目录的用户组（只可以对目录进行设置）。

SGID 的第一种功能是参考 SUID 而设计的，不同点在于执行程序的用户获取的不再是文件所有者的临时权限，而是获取到文件所属组的权限。每个文件都有其归属的所有者和所属组，当创建或传送一个文件后，这个文件就会自动归属于执行这个操作的用户（即该用户是文件的所有者）。如果现在需要在一个部门内设置共享目录，让部门内的所有人员都能够读取目录中的内容，那么就可以创建部门共享目录后，在该目录上设置 SGID 特殊权限位。这样，部门内的任何人员在里面创建的任何文件都会归属于该目录的所属组，而不再是自己的基本用户组。

```bash
$ ls -l /usr/bin/passwd
-rwsr-xr-x 1 root root 59640 Mar 23  2019 /usr/bin/passwd
```

### SBIT

SBIT 特殊权限位可确保用户只能删除自己的文件，而不能删除其他用户的文件。

当目录被设置 SBIT 特殊权限位后，文件的其他人权限部分的 x 执行权限就会被替换成 t 或者 T，原本有 x 执行权限则会写成 t，原本没有 x 执行权限则会被写成 T。

```bash
$ ls -ald /tmp
drwxrwxrwt 11 root root 4096 Jan 15 18:27 /tmp
```

设置 SBIT 特殊权限位：

```bash
$ chmod -R o+t sharedir
$ ls -ld sharedir
drwxrwsrwt 2 root root 4096 Jan 15 18:28 sharedir
```

## 文件的隐藏权限

Linux 系统中的文件除了具备一般权限和特殊权限之外，还有一种隐藏权限，即被隐藏起来的权限，默认情况下不能直接被用户发觉。

### chattr 命令

设置文件的隐藏权限，见 [chattr](../命令/chattr.md) 命令。

### lsattr 命令

显示文件的隐藏权限，见 [lsattr](../命令/lsattr.md) 命令。

## 文件访问控制列表

如果希望对某个指定的用户进行单独的权限控制，就需要用到文件的访问控制列表（ACL）。通俗来讲，基于普通文件或目录设置 ACL 其实就是针对指定的用户或用户组设置文件或目录的操作权限。另外，如果针对某个目录设置了 ACL，则目录中的文件会继承其 ACL；若针对文件设置了 ACL，则文件不再继承其所在目录的 ACL。

```bash
$ useradd -d /home/cxfans -u 1314 -s /bin/bash cxfans

$ su - cxfans
No directory, logging in with HOME=/

$ cd /root
-su: cd: /root: Permission denied
```

### setfacl 命令

管理文件的 ACL 规则，见 [setfacl](../命令/setfacl.md) 命令。文件的 ACL 提供的是在所有者、所属组、其他人的读/写/执行权限之外的特殊权限控制，使用 setfacl 命令可以针对单一用户或用户组、单一文件或目录来进行读/写/执行权限的控制。其中，针对目录文件需要使用 `-R` 递归参数；针对普通文件则使用 `-m` 参数；如果想要删除某个文件的 ACL，则可以使用 `-b` 参数。

```bash
$ setfacl -Rm u:cxfans:rwx /root

$ su - cxfans
# 该用户可以对 /root 目录进行读写
```

常用的 ls 命令是看不到 ACL 表信息的，但是却可以看到文件的权限最后一个点（.）变成了加号（+）,这就意味着该文件已经设置了 ACL 了。

```bash
$ ls -ld /root
drwxrwx---+ 23 root root 4096 Jan 16 09:46 /root
```

### getfacl 命令

显示文件上设置的 ACL 信息，见 [getfacl](../命令/getfacl.md) 命令。

```bash
$ getfacl /root
getfacl: Removing leading '/' from absolute path names
# file: root
# owner: root
# group: root
user::rwx
user:cxfans:rwx
group::---
mask::rwx
other::---
```

## su 命令与 sudo 服务

su 命令可以解决切换用户身份的需求，使得当前用户在不退出登录的情况下，顺畅地切换到其他用户，比如从 root 管理员切换至普通用户：

```bash
$ id
uid=0(root) gid=0(root) groups=0(root)

$ su cxfans
$ id
uid=1314(cxfans) gid=1314(cxfans) groups=1314(cxfans)
```

sudo 命令用于给普通用户提供额外的权限来完成原本 root 管理员才能完成的任务。见 [sudo](../命令/sudo.md) 命令。
