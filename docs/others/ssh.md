# 启用 SSH 服务

- [启用 SSH 服务](#启用-ssh-服务)
  - [配置网络服务](#配置网络服务)
  - [远程控制服务](#远程控制服务)
    - [配置 sshd 服务](#配置-sshd-服务)
    - [安全密钥验证](#安全密钥验证)
    - [远程传输命令](#远程传输命令)

## 配置网络服务

```bash
$ ls /etc/sysconfig/network-scripts/ifcfg*
/etc/sysconfig/network-scripts/ifcfg-eth0

$ cat /etc/sysconfig/network-scripts/ifcfg-eth0
DEVICE=eth0
BOOTPROTO=dhcp
ONBOOT=yes
```

当修改完 Linux 系统中的服务配置文件后，并不会对服务程序立即产生效果。要想让服务程序获取到最新的配置文件，需要手动重启相应的服务:

```bash
$ systemctl restart network
```

## 远程控制服务

### 配置 sshd 服务

SSH（Secure Shell）是一种能够以安全的方式提供远程登录的协议，也是目前远程管理Linux 系统的首选方式。。sshd 是基于 SSH 协议开发的一款远程管理服务程序，能够提供两种安全验证的方法：

- 基于口令的验证—用账户和密码来验证登录；
- 基于密钥的验证—需要在本地生成密钥对，然后把密钥对中的公钥上传至服务器，并与服务器中的公钥进行比较；该方式相较来说更安全。

sshd 服务的配置信息保存在 `/etc/ssh/sshd_config` 文件中。运维人员一般会把保存着最主要配置信息的文件称为主配置文件，而配置文件中有许多以井号开头的注释行，要想让这些配置参数生效，需要在修改参数后再去掉前面的井号。

| 参数 | 作用 |
| --------- | --------- |
| Port 22 | 默认的 sshd 服务端口 |
| ListenAddress 0.0.0.0 | 设定 sshd 服务器监听的 IP 地址 |
| Protocol 2 | SSH 协议的版本号 |
| HostKey /etc/ssh/ssh_host_key | SSH 协议版本为 1 时，DES 私钥存放的位置 |
| HostKey /etc/ssh/ssh_host_rsa_key | SSH 协议版本为 2 时，RSA 私钥存放的位置 |
| HostKey /etc/ssh/ssh_host_dsa_key | SSH 协议版本为 2 时，DSA 私钥存放的位置 |
| PermitRootLogin yes | 设定是否允许 root 管理员直接登录 |
| StrictModes yes | 当远程用户的私钥改变时直接拒绝连接 |
| MaxAuthTries 6 | 最大密码尝试次数 |
| MaxSessions 10 | 最大终端数 |
| PasswordAuthentication yes | 是否允许密码验证 |
| PermitEmptyPasswords no | 是否允许空密码登录（很不安全） |

在 RHEL 7 系统中，已经默认安装并启用了 sshd 服务程序。

一般的服务程序并不会在配置文件修改之后立即获得最新的参数。如果想让新配置文件生效，则需要手动重启相应的服务程序。最好也将这个服务程序加入到开机启动项中，这样系统在下一次启动时，该服务程序便会自动运行，继续为用户提供服务。

```bash
$ systemctl restart sshd
$ systemctl enable sshd
```

### 安全密钥验证

加密是对信息进行编码和解码的技术，它通过一定的算法（密钥）将原本可以直接阅读的明文信息转换成密文形式。密钥即是密文的钥匙，有私钥和公钥之分。在传输数据时，如果担心被他人监听或截获，就可以在传输前先使用公钥对数据加密处理，然后再行传送。这样，只有掌握私钥的用户才能解密这段数据，除此之外的其他人即便截获了数据，一般也很难将其破译为明文信息。

在生产环境中使用密码进行口令验证终归存在着被暴力破解或嗅探截获的风险。如果正确配置了密钥验证方式，那么 sshd 服务程序将更加安全。

1. 在客户端主机中生成“密钥对”

```bash
ssh-keygen -t rsa
```

2. 把客户端主机中生成的公钥文件传送至远程主机

```bash
ssh-copy-id -i ~/.ssh/id_rsa.pub root@120.77.220.48 -p13002
```

### 远程传输命令

scp（secure copy）是一个基于 SSH 协议在网络之间进行安全传输的命令，其格式为：

```
scp [参数] 本地文件 远程帐户@远程 IP 地址:远程目录
```

在使用 scp 命令把文件从本地复制到远程主机时，首先需要以绝对路径的形式写清本地文件的存放位置。如果要传送整个文件夹内的所有数据，还需要额外添加参数 `-r` 进行递归操作。然后写上要传送到的远程主机的 IP 地址，远程服务器便会要求进行身份验证了。当前用户名称为 root，而密码则为远程服务器的密码。如果想使用指定用户的身份进行验证，可使用`用户名@主机地址`的参数格式。最后需要在远程主机的 IP 地址后面添加冒号，并在后面写上要传送到远程主机的哪个文件夹中。只要参数正确并且成功验证了用户身份，即可开始传送工作。

```bash
$ scp LICENSE root@120.77.220.48:/root
LICENSE                             100% 1080    32.2KB/s   00:00
```

此外，还可以使用 scp 命令把远程主机上的文件下载到本地主机，其命令格式为：

```
scp [参数] 远程用户@远程 IP 地址:远程文件 本地目录
```

```bash
$ scp root@120.77.220.48:/etc/hosts .
hosts                               100%  178     6.6KB/s   00:00
```

当与远程主机的会话被关闭时，在远程主机上运行的命令也随之被中断。
